<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Admin Panel</title>
  <!-- Tell the browser to be responsive to screen width -->
  <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
  <!-- Bootstrap 3.3.6 -->
  <link rel="stylesheet" href="../bootstrap/css/bootstrap.min.css">
  <!-- Font Awesome -->
  <link href="../fontsv5/css/fontawesome.min.css" rel="stylesheet">
  <link href="../fontsv5/css/brands.min.css" rel="stylesheet">
  <link href="../fontsv5/css/solid.min.css" rel="stylesheet">

  <!-- Theme style -->
  <link rel="stylesheet" href="../dist/css/AdminLTE.min.css">
  <!-- AdminLTE Skins. Choose a skin from the css/skins
       folder instead of downloading all of them to reduce the load. -->
  <link rel="stylesheet" href="../dist/css/skins/_all-skins.css">
  <!-- DataTable -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.19/css/jquery.dataTables.css">  
  <!-- header fixed-->
  <link rel="stylesheet" href="../stylesheets/utils.css">
<!-- Datepicker-->
  <link rel="stylesheet" href="https://rawgit.com/Eonasdan/bootstrap-datetimepicker/master/build/css/bootstrap-datetimepicker.min.css">





  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
  <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
  <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
  <![endif]-->
</head>
<body class="hold-transition skin-purple sidebar-mini" onload="load_historical()"> 
<!-- Site wrapper -->

    <!-- Header -->
    <% include include/header.ejs %>
    <!-- Left Panel -->
    <% include include/leftpanel.ejs %>

  <!-- =============================================== -->

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper" id="mywrapper" style="overflow-y: auto; overflow-x: hidden;">
    <!-- Content Header (Page header) -->
    <!--section class="content-header">
      <h1>
        Blank page
        <small>it all starts here</small>
      </h1>
    </section-->


<div class="content "> <!-- CONTENT -->
  <div class="container">



      
  <!--div class="row col-md-12 col-sm-offset-1"-->

      <!--div class="text-center col-md-6">
              <div class="classWithPad">Widget 1</div>
          </div>
          <div class="text-center col-md-6">
              <div class="classWithPad">Widget 2</div>
          </div-->

          <div class=" row col-md-11" style="padding-top: 10px">



              <div class=" row col-lg-12 col-lg-offset-1 ">
                  <div class=" container col-lg-10  ">
          
                      <!--h1 align="center"> Selecciona un Bus</h1-->

                      <div align="center" style="font-size: 20px"><strong> SELECCIONE UNA FECHA DE INICIO Y FIN </strong></div>

                      <div class="form-group col-md-5" align="center" style="padding-top: 10px"> <!-- Date input -->
                        <label class="control-label" for="date">Fecha Inicial</label>
                        <div class='input-group date' id='date_initial'>
                            <input type='text' class="form-control"/>
                            <span class="input-group-addon">
                                <span class="glyphicon glyphicon-calendar"></span>
                            </span>
                        </div>
                      </div>
                      
                      <div class="form-group col-md-5" align="center" style="padding-top: 10px"> <!-- Date input -->
                        <label class="control-label" for="date">Fecha Final</label>
                        <div class='input-group date' id='date_final'>
                            <input type='text' class="form-control"/>
                            <span class="input-group-addon">
                                <span class="glyphicon glyphicon-calendar"></span>
                            </span>
                        </div>
                      </div>

                      <div class="form-group col-md-2"  style="padding-top: 25px"> <!-- Date input -->
                        <span class="input-group-btn">
                            <button class="btn btn-info btn-lg" type="button" onclick="load_historical()">
                                <i class="glyphicon glyphicon-search"></i>
                            </button>
                        </span>
                      </div>
                      
                   

                  </div>
              </div> 

          </div>
           


          <div class=" row col-md-11">



              <div class=" row col-lg-12 col-lg-offset-1 ">
                  <div class=" container col-lg-10  ">
          
                      <!--h1 align="center"> Selecciona un Bus</h1-->

                      <div align="center" style="font-size: 20px"><strong> SELECCIONE UN TURNO </strong></div>
         
                      <table class="table table-striped table-condensed "  id="info_table" > <!--table-condensed-->
                          <thead  class="bg-primary" >
                            <tr>
                              <th ><p align="center">#</p></th>
                              <th ><p align="center"> Inicio Turno </p></th>
                              <th ><p align="center"> Fin Turno </p></th>
                              <th ><p align="center"> Placa </p></th>
                              <th ><p align="center"> Conductor </p></th>
                              <th ><p align="center"> Dni </p></th>
                              <th ><p align="center"> Ruta </p></th>
                              <th ><p align="center"> Selecci√≥n </p></th>
                            </tr>
                          </thead>
                          <tbody align="center">
                           
                          </tbody>
                        </table>
                      </div>
                    </div> 

          </div>
 
     
              <div class="row col-md-11 ">
                      
                  <div class="card" style="padding-top: 20px">
                  <div class="card-header" align="center" style="font-size: 20px"><strong> HISTORIAL DE BUSES</strong></div>
         
                  
                  <div class="card-body card-block">
                      <br>
                      <div class="form-group" align="center">
                          
                        <li class="list-group-item" style="font-size: 18px" >
                              <span class="pull-left"><i class="fa fa-eraser" onclick="reset_position()" ></i></span>
                              <a style="white-space: nowrap;">BUS SELECCIONADO: </a> <a style="color:black" id="actual_bus_plate">Ninguno </a>
                              
                              <a style="white-space: nowrap; margin-left: 50px;" >CONDUCTOR: </a> <a style="color:black" id="actual_bus_dni">Ninguno </a>
                              <span class="pull-right"><i class="fa fa-bus " id="actual_bus_color" onclick="zoom_markers()"></i></span>
                          </li>

                              <div style="margin:5px"></div>
                          <div id="map" style="width: 100%; height: 500px; border:2px solid black; "></div>

                      </div>

                  </div>
                  </div>
              </div>

              <!-- Button trigger modal -->

          </div>
      


            
  <!--/div-->         
  

</div> <!-- END CONTENT -->
   

  </div>
  <!-- /.content-wrapper -->


  <% include include/footer.ejs %>

  


  <!-- jQuery 2.2.3 -->
  <script src="../plugins/jQuery/jquery-2.2.3.min.js"></script>
  <!-- Bootstrap 3.3.6 -->
  <script src="../bootstrap/js/bootstrap.min.js"></script>
  <!-- DataTable -->
  <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.js"></script>
  <!-- AdminLTE App -->
  <script src="../dist/js/app.min.js"></script>
  <!-- Color Picker -->
  
  <!--script src="../js/jscolor.js"></script-->

<!-- Datepicker -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"></script>
<script src="https://rawgit.com/Eonasdan/bootstrap-datetimepicker/master/build/js/bootstrap-datetimepicker.min.js"></script>
<!-- Timezone-->
<script src= "../js/moment-timezone-withdata.js" ></script>

  



<!--Pagination datatable-->

<!--script src="https://cdn.datatables.net/1.10.19/js/dataTables.bootstrap.min.js"></script> 

<script src="https://cdn.datatables.net/1.10.19/js/jquery.dataTables.min.js"></script> 

<link src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet"> 
<link src="https://cdn.datatables.net/1.10.19/css/dataTables.bootstrap.min.css" rel="stylesheet"> 
<script src="https://code.jquery.com/jquery-3.3.1.js"></script--> 


<script>



function init_dates(){

    var dateOffset = (24*60*60*1000); //oneday
    var initial_date = new Date();
    initial_date.setTime(initial_date.getTime() - dateOffset);


    $('#date_initial').datetimepicker({
      defaultDate: initial_date,
      format: 'YYYY-MM-DD HH:mm:ss ',
      //format: 'DD/MM/YYYY hh:mm:ss A',

      sideBySide: true
    });

    
    /*
    $('#date_initial').datepicker().on('changeDate', function (ev) {
      //$('#date-daily').change();
      alert("filtrando");
    });*/

    $('#date_final').datetimepicker({
      defaultDate: new Date(),
      format: 'YYYY-MM-DD HH:mm:ss ', 
      //format: 'DD/MM/YYYY hh:mm:ss A',
      sideBySide: true
    });


    /*
    $('#date_initial').datetimepicker().on('dp.change',function(e){
        //console.log(e.date._i)
        //$("#date_initial").find("input").val();
        //$("#date_final").find("input").val();
        load_historical();
    });

    $('#date_final').datetimepicker().on('dp.change',function(e){
        //console.log(e.date._i)
        //$("#date_initial").find("input").val();
        //$("#date_final").find("input").val();
        load_historical();

    });*/


}


var map=null;

var icon_time=null;

function GetHistorical(){

    var initial_date = $("#date_initial").find("input").val();
    var final_date = $("#date_final").find("input").val();

    //initial_date = initial_date.substring(0, initial_date.length - 1);
    //final_date = final_date.substring(0, final_date.length - 1);

    console.log(initial_date);
    console.log(final_date);
    //var todayDate = new Date().toISOString().
    //const nDate = new Date().toLocaleString('es-PE', {timeZone: 'America/Lima'})

    
    return JSON.parse($.ajax({
        type: "POST",
        data: {initial_date:initial_date,final_date:final_date},
        url: "/admin/historical-turns/all",
        cache: false,
        async: false
    }).responseText);
    
}

function GetHistoricalById(id_actual_driver,turn_init,turn_end){

    //var initial_date = $("#date_initial").find("input").val();
    //var final_date = $("#date_final").find("input").val();


    return JSON.parse($.ajax({
        type: "POST",
        url: "/admin/historical-turns/id",
        data: {
          id_actual_driver:id_actual_driver,
          initial_date:turn_init,
          final_date:turn_end
        },
        cache: false,
        async: false
    }).responseText);
}



var all_info;
var id_button_selected=undefined;
var historical_marker=[]; 
var markerBounds = null;
function look_for_historical(id){
    
    var actual_bus = all_info[id]; 
    //var plate = actual_bus.plate;

    $("#actual_bus_color").css("color","#"+actual_bus.actual_driver.route.color);
    $("#actual_bus_plate").text(actual_bus.actual_driver.bus.plate);
    $("#actual_bus_dni").text(actual_bus.actual_driver.driver.dni);

    //var id_btn=""
    //$("#btn_historical"+id).prop('disabled', true); 
    reset();

    map_historical(actual_bus.id_actual_driver,actual_bus.turn_init,actual_bus.turn_end,actual_bus.actual_driver.route.color);
    id_button_selected = "#btn_historical"+id; 
    //$("#btn_historical"+id).prop("disabled",true);
    $(id_button_selected).attr("disabled", true);
    $(id_button_selected).css("color","#999999");



    //this.disabled=true;
}

function reset(){
  if(id_button_selected!=undefined){
    $(id_button_selected).removeAttr('disabled');
    $(id_button_selected).removeAttr('style');

    historical_marker.forEach(function(marker){
      marker.setMap(null);
    });
  }
}

/*
function toTimeZone(time, zone) {
    //var format = 'YYYY/MM/DD HH:mm:ss';
    //return moment(time, format).tz(zone).format(format);
     
    //return moment(time).tz('America/Lima').format(format)
    //return moment(time, 'YYYY-MM-DD HH:mm:ss').tz('UTC').format(); // "2018-07-18T00:00:00Z"
    return moment(time).utcOffset(-600).format('YYYY-MM-DD HH:mm:ss');
}*/


function map_historical(id_actual_driver,turn_init,turn_end,color){
  
   //console.log("TURN INIT: "+turn_init);
   //console.log("TURN END: "+turn_end);
   
   //server save the hour in utc peru America/Lima  | PET    | -05:00:00  | f
   var start = moment(turn_init).utcOffset(-600).format('YYYY-MM-DD HH:mm:ss');
   var end = moment(turn_end).utcOffset(-600).format('YYYY-MM-DD HH:mm:ss');


   //var historical = GetHistoricalById(id_actual_driver,turn_init,turn_end);
   var historical = GetHistoricalById(id_actual_driver,start,end);

   console.log("HISTORICAL");
   console.log(historical);
   //{id: 3345, latitude: -16.40037, longitude: -71.496269, date: "2019-09-08T20:54:43.713Z", id_actual_driver: 37}
   
   icon_time = {
      path: "M7.8,1.3L7.8,1.3C6-0.4,3.1-0.4,1.3,1.3c-1.8,1.7-1.8,4.6-0.1,6.3c0,0,0,0,0.1,0.1" +
      "l3.2,3.2l3.2-3.2C9.6,6,9.6,3.2,7.8,1.3C7.9,1.4,7.9,1.4,7.8,1.3z M4.6,5.8c-0.7,0-1.3-0.6-1.3-1.4c0-0.7,0.6-1.3,1.4-1.3" +
      "c0.7,0,1.3,0.6,1.3,1.3C5.9,5.3,5.3,5.9,4.6,5.8z",
      strokeColor: '#333' ,
      fillColor: "#"+color,
      fillOpacity: 1.0,
      scale: 2
  };

  markerBounds = new google.maps.LatLngBounds();   
  var date=null; 
  historical.forEach( function(data){
      
      var location = new google.maps.LatLng(parseFloat(data.latitude), parseFloat(data.longitude)); 
      //console.log(location);
      console.log(data.date);
      //console.log(data.date.toLocaleString());

      //var date = data.date.toLocaleString('es-PE', {timeZone: 'America/Lima'});
 
      //var date = toTimeZone(data.date, 'America/Lima');
      //console.log(date);

      date = moment(data.date).utcOffset(-600).format('YYYY-MM-DD HH:mm:ss');

      var marker = addMarker(location,date);
      historical_marker.push(marker);
      markerBounds.extend(location);
  
   });

   zoom_markers();
   //zoom with markers

   /*
   var markerBounds = new google.maps.LatLngBounds();
   var first=0;
   var last= historical.length-1; 
   var first_pos = new google.maps.LatLng(parseFloat(historical[first].latitude), parseFloat(historical[first].longitude)); 
   var last_pos = new google.maps.LatLng(parseFloat(historical[last].latitude), parseFloat(historical[last].longitude)); 
   
   markerBounds.extend(first_pos);
   markerBounds.extend(last_pos);
   map.fitBounds(markerBounds);
   map.setCenter(markerBounds.getCenter());
   */


   //alert("maping actual driver" + id_actual_driver);
}

function zoom_markers(){
   map.fitBounds(markerBounds);
   //map.panToBounds(markerBounds);
}



function addMarker(location,info) {

    //console.log("adding marker");
    var marker = new google.maps.Marker({
      position: location,
      map: map,
      title: info,
      icon: icon_time
    });

    var infowindow = new google.maps.InfoWindow({
        content: info
    });
  
    marker.addListener('click', function() {
          infowindow.open(map, marker);
    });
    return marker;
}


function reset_position(){

    //var position_predefined = {lat: -16.410289532532197, lng: -71.51547454720765};
    var position_predefined = {lat: -14.3404091, lng: -72.3320796};

    //map.setZoom(13);
    map.setZoom(7);

    map.panTo(position_predefined); //Make map global
    //bus_id_selected = -1;
    reset();
    $("#actual_bus_color").css("color","black");
    $("#actual_bus_plate").text("Ninguno");
}



//var list_buses;
var table = null;
function load_historical(){
    init_dates();

    all_info = GetHistorical();
    console.log("ALL INFO");
    console.log(all_info);

    if(table==null){
      table = $('#info_table');
    }
    else{
      //table.empty();
      $('#info_table tbody').empty();
    }

    var i=1;
    all_info.forEach(function (info) {

        //console.log(info);
        var turn_init =  moment(info.turn_init).utcOffset(-600).format('YYYY-MM-DD HH:mm:ss');
        var turn_end =  moment(info.turn_end).utcOffset(-600).format('YYYY-MM-DD HH:mm:ss');
        

        table.append("<tr><td>" + i + "</td><td>" + turn_init +"</td><td>"+ turn_end +"</td><td>"
          + info.actual_driver.bus.plate + "</td><td>"+ info.actual_driver.driver.name  +"</td><td>"+
            info.actual_driver.driver.dni +"</td><td style='background-color:#"+info.actual_driver.route.color +"'>"+info.actual_driver.route.name+"</td><td>"+
              "<button class='rbutton' onclick='look_for_historical("+ (i-1) +")' id=btn_historical"+ (i-1) +" >seleccionar </button></td></tr>");
        i++;
    });
    if(table!=null){
      table.DataTable();
    }
}


function load_drivers(){

}

function ChangeOption(obj){

    var value = obj.value;
    alert(value);
}



function initMap() { 
  //var myLatLng = {lat: -16.410289532532197, lng: -71.51547454720765};
  var myLatLng = {lat: -14.3404091, lng: -72.3320796};

  
    map = new google.maps.Map(document.getElementById('map'), {
    zoom: 7, //13
    center: myLatLng
  });

  /*
  icon_time = {
        url: "/images/marker-time.svg", // url
        scaledSize: new google.maps.Size(25, 25), // scaled size
        origin: new google.maps.Point(0,0), // origin
        anchor: new google.maps.Point(0, 0) // anchor
  };*/


 

}


</script>


<script sync defer
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDuXDID0Yxm6vW2TNZs6IftRLsYGJ_NWiQ&callback=initMap">
</script>

</body>
</html>




